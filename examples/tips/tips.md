# Kubernetes Trouble-shooting Tips

## Pod cannot be deleted
Pods cannot be deleted if it's host goes down (the host state becomes `NotReady` and pods state become `Unknown`). This is an expected behavior since 1.5. Below command can be used to force delete the pods:
```shell
kubectl delete pod <pod_name> --grace-period=0 --force
```

## Cannot ping pods IP from a different host. 
This could be caused by various setup issues: flannel is not running properly, firewall blocks the ICMP packet, IP forwarding is disabled etc. To diagnose this, the following steps might be helpful to narrow down where the actual problem is. 
1. Ping the machine of where the pod is running and see if the machine is reachable, (`kubectl get pods -o wide` to get the machine IP). If this works it means the network is fine between those two nodes. 
2. Check if `firewalld` is running. CentOS 7 is default to use `firewalld`. `systemctl stop firewalld` to stop the firewall.
3. Check if Flannel is running and if docker network is using the values generated by `mk-docker-opts.sh`. Please refer to [setup-services](../wrap-up/setup-services.md) for Flannel and Docker configurations.
4. If Flannel is running and Docker is using Flannel network, try to ping Docker gateway IP Address. In the below example, `172.30.66.1`.
```shell
$ ip a
...
3: flannel.1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN group default
    link/ether 8a:54:d4:27:50:55 brd ff:ff:ff:ff:ff:ff
    inet 172.30.66.0/32 scope global flannel.1
       valid_lft forever preferred_lft forever
    inet6 fe80::8854:d4ff:fe27:5055/64 scope link
       valid_lft forever preferred_lft forever
4: docker0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP group default
    link/ether 02:42:21:d4:71:8c brd ff:ff:ff:ff:ff:ff
    inet 172.30.66.1/24 brd 172.30.66.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:21ff:fed4:718c/64 scope link
       valid_lft forever preferred_lft forever
...
```
4. If Docker gateway is reachable from the other node, check if IP forwarding is enabled: `sysctl net.ipv4.conf.all.forwarding`. If the value is `0`, run `sysctl net.ipv4.conf.all.forwarding=1` to enable it temporarily (will not persist after reboot) or add `net.ipv4.conf.all.forwarding=1` to `/etc/sysctl.d/` and reboot the system.
5. Check if `iptables` `FORWARD` policy is `ACCEPT`. Since Docker 1.13, the policy is default to `DROP`. To enable it, run `sudo iptables -P FORWARD ACCEPT`.
[This](https://docs.docker.com/v17.09/engine/userguide/networking/default_network/container-communication/#communicating-to-the-outside-world) article explains a lot details about the Docker network.

## Remove labels from nodes

To remove a label from a node, use: `kubectl label node <nodename> <labelname>-`. For example: `kubectl label nodes 192.168.1.52 hardware-` to remove `hardware` label from `192.168.1.52`.

To update a label on a node, use `--overwrite` flag. For example: `kubectl label nodes 192.168.1.52 hardware=high --overwrite` will update `hardware` to `high` and overwrite its old value.

## PING from virtual machine results in (DUP!) 
This is Virtual machine network connectivity issues with VirtualBox. Using ping command will cause duplicate packets.

To mitigate this, we need to disable host operating system's IP forwarding(which we do not want to because we need that so containers from different hosts can reach each other):
```shell
# sysctl -w net.ipv4.ip_forward=0
net.ipv4.ip_forward = 0
```
